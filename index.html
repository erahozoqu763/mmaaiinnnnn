<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üíé PowerMine ‚Äî SafeChain</title>

    <!-- –¢–≤—ñ–π —Å—Ç–∏–ª—å/–∞–Ω—ñ–º–∞—Ü—ñ—ó –º–∞–π–Ω–µ—Ä–∞ -->
    <link rel="stylesheet" href="https://erahozoqu763.github.io/maker/mainer.css" />

    <!-- Telegram WebApp SDK (—â–æ–± –∑–∞–±—Ä–∞—Ç–∏ tg_user_id —É –±–æ—Ç—ñ) -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- ethers v6 –¥–ª—è MetaMask -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.min.js"></script>

    <!-- –¢–≤–æ—è –ª–æ–≥—ñ–∫–∞ –º–∞–π–Ω–µ—Ä–∞ (—Å–ø—ñ–¥–æ–º–µ—Ç—Ä/–∑–∞—Ä—è–¥/–ª–æ–∫–∞–ª—å–Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è) -->
    <script src="https://erahozoqu763.github.io/maker/mainer.js" defer></script>

    <style>
        /* –ù–µ–≤–µ–ª–∏–∫–∏–π –¥–æ–¥–∞—Ç–∫–æ–≤–∏–π —Å—Ç–∏–ª—å –¥–ª—è Web3-–ø–∞–Ω–µ–ª—ñ */
        .web3-panel {
            margin: 16px auto 0;
            max-width: 980px;
            padding: 12px 14px;
            border-radius: 12px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
        }
        .web3-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }
        .web3-btn {
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.06);
            color: #fff;
            cursor: pointer;
        }
        .web3-btn[disabled] {
            opacity: 0.55;
            cursor: default;
        }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
        .muted { color: #9aa3b2; }
        .ok { color: #36c692; }
        .warn { color: #ffcc66; }
        .err { color: #ff6b6b; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üíé PowerMine</h1>
            <p class="subtitle">–ú–∞–π–Ω—å SC –∏ —É—Å–∫–æ—Ä—è–π —Å–≤–æ–π –¥–æ—Ö–æ–¥</p>
        </header>

        <!-- üîó Web3-–ø–∞–Ω–µ–ª—å (MetaMask + –ø—Ä–∏–≤'—è–∑–∫–∞ –¥–æ Telegram + –∫–æ–Ω—Ñ—ñ–≥ –±–µ–∫–µ–Ω–¥—É) -->
        <section class="web3-panel">
            <div class="web3-row" style="margin-bottom:8px;">
                <button id="btnConnect" class="web3-btn">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å MetaMask</button>
                <button id="btnDisconnect" class="web3-btn" disabled>‚èèÔ∏è –û—Ç–∫–ª—é—á–∏—Ç—å</button>
                <button id="btnBind" class="web3-btn" disabled>‚úçÔ∏è –ü–æ–¥–ø–∏—Å–∞—Ç—å –ø—Ä–∏–≤—è–∑–∫—É</button>
                <span id="netInfo" class="muted">‚Äî</span>
            </div>
            <div class="web3-row">
                <div style="flex:1 1 320px;">
                    <div class="muted">–ê–¥—Ä–µ—Å:</div>
                    <div id="addr" class="mono">‚Äî</div>
                </div>
                <div style="flex:1 1 240px;">
                    <div class="muted">SPENDER (–∏–∑ API):</div>
                    <div id="cfgSpender" class="mono">‚Äî</div>
                </div>
                <div style="flex:1 1 240px;">
                    <div class="muted">Chain ID (–∏–∑ API):</div>
                    <div id="cfgChainId" class="mono">‚Äî</div>
                </div>
            </div>
            <div class="web3-row" style="margin-top:8px;">
                <div style="flex:1 1 100%;">
                    <div id="bindState" class="mono muted">–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É WebApp –≤ –±–æ—Ç–µ ‚Äî —Ç–æ–≥–¥–∞ —è —É–≤–∏–∂—É —Ç–≤–æ–π Telegram ID.</div>
                </div>
            </div>
        </section>

        <!-- –¢–≤–æ—è –ø–∞–Ω–µ–ª—å –º–∞–π–Ω–µ—Ä–∞ —è–∫ —î -->
        <div class="miner-panel">
            <div class="fan-container">
                <img id="fanImg" src="https://erahozoqu763.github.io/maker/img/mainer.png" alt="SafeChain –ú–∞–π–Ω–µ—Ä" draggable="false"/>
                <div class="charge-indicator">
                    <span id="chargePercent">100%</span>
                </div>
            </div>

            <div class="stats">
                <div class="stat">
                    <span>‚ö° –°–∫–æ—Ä–æ—Å—Ç—å:</span>
                    <b id="speed">0.000000001</b> <small>SC/—Å–µ–∫</small>
                </div>
                <div class="stat">
                    <span>‚õèÔ∏è –ù–∞–º–∞–π–Ω–µ–Ω–æ:</span>
                    <b id="mined">0</b> <small>SC</small>
                </div>
                <div class="stat">
                    <span>üí∞ –ë–∞–ª–∞–Ω—Å:</span>
                    <b id="balance">0</b> <small>SC</small>
                </div>
                <div class="stat">
                    <span>üîã –ë—É—Å—Ç:</span>
                    <b id="boost">x1</b>
                </div>
            </div>

            <div class="progress-container">
                <label>–ó–∞—Ä—è–¥ –º–∞–π–Ω–µ—Ä–∞:</label>
                <div class="progress-bar">
                    <div id="chargeBar" class="progress"></div>
                </div>
            </div>

            <div class="actions">
                <button id="charge" class="btn btn-green">üîã –ó–∞—Ä—è–¥–∏—Ç—å –º–∞–π–Ω–µ—Ä</button>
                <button id="upgrade" class="btn btn-accent">‚ö° –£—Å–∫–æ—Ä–∏—Ç—å</button>
            </div>

            <p class="hint">‚è≥ –ú–∞–π–Ω–∏–Ω–≥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –¥–∞–∂–µ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è WebApp ‚Äî –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.</p>
        </div>
    </div>

    <!-- üîß –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –Ω–∞—à–∏–º –±–µ–∫–µ–Ω–¥–æ–º (–ø—Ä–∏–≤—è–∑–∫–∞ –∫–æ—à–µ–ª—å–∫–∞ –∫ Telegram) -->
    <script>
        // ‚ö†Ô∏è –ü–û–î–ú–ï–ù–ò –Ω–∞ —Å–≤–æ–π –ø—É–±–ª–∏—á–Ω—ã–π URL API (sslip.io –∏–ª–∏ –¥–æ–º–µ–Ω)
        const API_BASE_URL = "https://api.103.246.147.200.sslip.io";

        const STATE = {
            provider: null,
            signer: null,
            account: null,
            chainId: null,
            config: null
        };

        function tgUserId() {
            // 1) Telegram WebApp
            try {
                if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe?.user?.id) {
                    return Number(Telegram.WebApp.initDataUnsafe.user.id);
                }
            } catch (e) {}
            // 2) ?tg_user_id=... (—Ä–µ–∑–µ—Ä–≤ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ)
            const q = new URLSearchParams(location.search);
            const v = q.get("tg_user_id");
            return v ? Number(v) : null;
        }

        function el(id) { return document.getElementById(id); }

        async function apiGet(path) {
            const r = await fetch(API_BASE_URL + path, { credentials: "omit" });
            if (!r.ok) throw new Error("API " + path + " failed: " + r.status);
            return r.json();
        }
        async function apiPost(path, body) {
            const r = await fetch(API_BASE_URL + path, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
            });
            if (!r.ok) throw new Error("API " + path + " failed: " + r.status);
            return r.json();
        }

        async function loadConfig() {
            const cfg = await apiGet("/api/config");
            STATE.config = cfg;
            el("cfgSpender").textContent = cfg.spender;
            el("cfgChainId").textContent = String(cfg.chainId);
        }

        async function connect() {
            if (!window.ethereum) {
                alert("MetaMask –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∏–ª–∏ –æ—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–æ—à–µ–ª—å–∫–∞.");
                return;
            }
            STATE.provider = new ethers.BrowserProvider(window.ethereum);
            await window.ethereum.request({ method: "eth_requestAccounts" });
            STATE.signer = await STATE.provider.getSigner();
            STATE.account = await STATE.signer.getAddress();

            const net = await STATE.provider.getNetwork();
            STATE.chainId = Number(net.chainId);

            el("addr").textContent = STATE.account;
            el("netInfo").textContent = "chainId=" + STATE.chainId;
            el("btnDisconnect").disabled = false;
            el("btnBind").disabled = false;

            // –ï—Å–ª–∏ —Å–µ—Ç—å –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–æ–Ω—Ñ–∏–≥–æ–º API ‚Äî –ø–æ–ø—Ä–æ—Å–∏–º –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å
            if (STATE.config && STATE.chainId !== Number(STATE.config.chainId)) {
                try {
                    await window.ethereum.request({
                        method: "wallet_switchEthereumChain",
                        params: [{ chainId: ethers.toBeHex(Number(STATE.config.chainId)) }]
                    });
                    const n2 = await STATE.provider.getNetwork();
                    STATE.chainId = Number(n2.chainId);
                    el("netInfo").textContent = "chainId=" + STATE.chainId;
                } catch (e) {
                    // –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å ‚Äî –ø—Ä–æ—Å—Ç–æ –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏–º
                    el("bindState").innerHTML = "‚ö†Ô∏è <span class='warn'>–°–µ—Ç—å –≤ –∫–æ—à–µ–ª—å–∫–µ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–æ–Ω—Ñ–∏–≥–æ–º API.</span>";
                }
            }
        }

        async function disconnect() {
            STATE.provider = null;
            STATE.signer = null;
            STATE.account = null;
            STATE.chainId = null;
            el("addr").textContent = "‚Äî";
            el("netInfo").textContent = "‚Äî";
            el("btnDisconnect").disabled = true;
            el("btnBind").disabled = true;
            el("bindState").textContent = "–û—Ç–∫–ª—é—á–µ–Ω–æ.";
        }

        function buildBindMessage(tgId, address) {
            const now = new Date().toISOString();
            const nonce = Math.random().toString(36).slice(2);
            return `SafeChain Wallet Bind

Bind Telegram ID: ${tgId}
Address: ${address}
ChainId: ${STATE.chainId}
Timestamp: ${now}
Nonce: ${nonce}`;
        }

        async function signAndBind() {
            const id = tgUserId();
            if (!id) {
                el("bindState").innerHTML = "‚ö†Ô∏è <span class='warn'>–ù–µ –Ω–∞–π–¥–µ–Ω Telegram ID. –û—Ç–∫—Ä–æ–π —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ WebApp –≤ –±–æ—Ç–µ –∏–ª–∏ –¥–æ–±–∞–≤—å ?tg_user_id=...</span>";
                return;
            }
            if (!STATE.signer || !STATE.account) {
                alert("–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏ –∫–æ—à–µ–ª–µ–∫.");
                return;
            }
            const msg = buildBindMessage(id, STATE.account);
            let sig;
            try {
                sig = await STATE.signer.signMessage(msg);
            } catch (e) {
                el("bindState").innerHTML = "‚ùå <span class='err'>–ü–æ–¥–ø–∏—Å—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.</span>";
                return;
            }
            try {
                const res = await apiPost("/api/bind", {
                    tg_user_id: Number(id),
                    address: STATE.account,
                    message: msg,
                    signature: sig
                });
                if (res && res.ok) {
                    el("bindState").innerHTML = "‚úÖ <span class='ok'>–ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –Ω–∞ –±–µ–∫–µ–Ω–¥–µ.</span>";
                } else {
                    el("bindState").innerHTML = "‚ö†Ô∏è <span class='warn'>–û—Ç–≤–µ—Ç API –±–µ–∑ ok=true.</span>";
                }
            } catch (e) {
                el("bindState").innerHTML = "‚ùå <span class='err'>–û—à–∏–±–∫–∞ API bind: " + (e.message || e) + "</span>";
            }
        }

        // bootstrap
        document.addEventListener("DOMContentLoaded", async () => {
            // –∫–æ–Ω—Ç–µ–∫—Å—Ç –±–æ—Ç–∞ (–ø–æ–∫–∞–∂–µ–º, –Ω–∞—à–ª–∏ –ª–∏ user id)
            const tid = tgUserId();
            if (tid) {
                el("bindState").textContent = "Telegram ID –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ: " + tid;
            }
            try {
                await loadConfig();
            } catch (e) {
                el("bindState").innerHTML = "‚ùå <span class='err'>API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å API_BASE_URL –∏ CORS.</span>";
            }
            document.getElementById("btnConnect").addEventListener("click", connect);
            document.getElementById("btnDisconnect").addEventListener("click", disconnect);
            document.getElementById("btnBind").addEventListener("click", signAndBind);
        });
    </script>
</body>
</html>
